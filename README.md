# NewsHarvestR - ETL Pipeline для обработки новостей из TT-RSS с использованием YandexGPT

## Цель проекта

Целью проекта является автоматизация сбора, анализа и визуализации новостей из различных источников RSS. Система автоматически извлекает непрочитанные новости из TT-RSS (Tiny Tiny RSS), проводит их анализ с использованием YandexGPT, сохраняет результаты в PostgreSQL базе данных и предоставляет интерактивный дашборд для анализа новостного потока. Это позволяет эффективно отслеживать и классифицировать значимые новости без ручного просмотра большого объема информации.

## Функции и модули

### 1. API-клиент для TT-RSS ([`R/ttrss_client.R`](R/ttrss_client.R:1))

Реализован модуль с использованием библиотеки `httr2`, который обеспечивает:
- Авторизацию через API и получение `session_id` для последующих запросов
- Получение непрочитанных (fresh) новостей из всех лент
- Конвертацию JSON данных в R DataFrame
- Функцию отметки новостей как прочитанных

### 2. Клиент YandexGPT ([`R/llm_client.R`](R/llm_client.R:1))

Разработан модуль для взаимодействия с Yandex Cloud Foundation Models с настроенным системным промптом для выполнения трех задач за один проход:
- Классификации текста (короткий тег, максимум 2 слова)
- Суммаризации (короткое содержание, максимум 1 предложение)
- Оценки важности для IT (число 1-10)

### 3. Модуль хранения данных ([`R/db_storage.R`](R/db_storage.R:1))

Разработан модуль для:
- Подключения к PostgreSQL базе данных
- Создания таблицы `news_analysis` при необходимости
- Сохранения результатов анализа новостей в базу данных с защитой от дублирования
- Обеспечения безопасности через параметризованные запросы

### 4. Модуль очистки текста ([`R/text_cleaner.R`](R/text_cleaner.R:1))

Разработан модуль для:
- Удаления HTML тегов, скриптов и стилей из текста новостей
- Очистки текста от лишних пробелов
- Подготовки текста для корректной обработки LLM и обеспечения качества входных данных

### 5. Основной пайплайн ([`R/pipeline.R`](R/pipeline.R:1))

Создан управляющий скрипт, который:
- Объединяет все компоненты системы
- Настроена работа с переменными окружения (.env) для безопасности ключей API
- Реализована интеграция всех компонентов
- Внедрена обработка ошибок и логирование процесса
- Обеспечивает обработку указанного количества новостей за один запуск

### 6. Аналитический дашборд ([`R/run_dashboard.R`](R/run_dashboard.R:1) и [`inst/dashboard/app.R`](inst/dashboard/app.R:1))

Разработан интерактивный дашборд с визуализацией обработанных новостей из базы данных, включающий:
- КПЭ (общее количество новостей, средняя оценка, топ категории)
- Временную динамику публикаций
- Распределение оценок релевантности
- Таблицу последних новостей с возможностью фильтрации по дате, категории и оценке
- Часовое распределение новостей
- Тепловую карту по дням и категориям

### 7. MCP сервер ([`mcp/server.py.txt`](mcp/server.py.txt:1))

Реализован сервер MCP (Model Context Protocol) для взаимодействия с TT-RSS, обеспечивающий:
- Инструменты для получения активных функций
- Инструменты для авторизации в TT-RSS
- Инструменты для поиска заголовков новостей
- Безопасность транспорта и проверку хостов

## Детальное описание пайплайна

### Общая архитектура

Пайплайн автоматически получает непрочитанные новости из TT-RSS, очищает их от HTML-разметки, анализирует с помощью YandexGPT (классификация, суммаризация, оценка релевантности), сохраняет результаты в PostgreSQL и отмечает новости как прочитанные. Процесс запускается периодически с заданным интервалом и обрабатывает указанное количество новостей за каждый запуск. Система включает в себя обработку ошибок и логирование для обеспечения надежности и отслеживания состояния процесса.

### Процесс обработки

1. **Инициализация**:
   - Загрузка переменных окружения из .env файла
   - Подключение к TT-RSS и получение сессии
   - Подключение к PostgreSQL и создание таблицы `news_analysis` при необходимости

2. **Получение новостей**:
   - Запрос непрочитанных новостей из TT-RSS (ограничение по количеству)
   - Проверка наличия новых новостей

3. **Обработка каждой новости**:
   - Очистка текста от HTML-разметки с помощью модуля `text_cleaner.R`
   - Классификация, суммаризация и оценка важности с помощью YandexGPT
   - Сохранение результатов в базу данных `news_analysis` с проверкой на дубликаты
   - Отметка новости как прочитанной в TT-RSS

4. **Обработка ошибок**:
   - Обработка ошибок на каждом этапе с продолжением обработки остальных новостей
   - Логирование ошибок для последующего анализа
   - Пауза между обработкой новостей для предотвращения перегрузки API

5. **Завершение**:
   - Корректное закрытие соединений с базой данных
   - Логирование завершения процесса

### Используемые переменные окружения

- `TTRSS_URL`, `TTRSS_USER`, `TTRSS_PASS` - параметры для подключения к TT-RSS
- `YA_FOLDER_ID`, `YA_API_KEY` - параметры для доступа к YandexGPT
- `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASS` - параметры для подключения к PostgreSQL
- `PIPELINE_ITEMS_COUNT` - количество новостей для обработки за один запуск (по умолчанию 5)
- `PIPELINE_INTERVAL` - интервал между запусками пайплайна в секундах (по умолчанию 300)

## Архитектура

### Общая схема

Система построена по модульной архитектуре с использованием Docker-контейнеров. Основные компоненты включают:

- **TT-RSS сервер** - для получения новостей из различных RSS-лент
- **PostgreSQL база данных** - для хранения проанализированных новостей
- **Пайплайн на R** - для обработки и анализа новостей
- **Дашборд на Shiny** - для визуализации и анализа данных
- **MCP сервер** - для взаимодействия с TT-RSS через Model Context Protocol

### Важное замечание об архитектуре

**База данных с проанализированными новостями изолирована и находится на отдельном инстансе.** Это обеспечивает:
- Повышенную безопасность данных
- Независимость от основной инфраструктуры TT-RSS
- Возможность масштабирования и резервного копирования
- Разделение зон ответственности между системами

### Схема взаимодействия компонентов
![](./images/arch.png)

### Структура базы данных

#### Таблица `news_analysis`

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | SERIAL | Уникальный идентификатор записи (первичный ключ) |
| `news_id` | TEXT | Уникальный идентификатор новости из TT-RSS |
| `title` | TEXT | Заголовок новости |
| `link` | TEXT | Ссылка на новость |
| `published_at` | TIMESTAMP | Дата публикации новости |
| `category` | TEXT | Категория новости, определенная с помощью ИИ |
| `summary` | TEXT | Краткое содержание новости, сгенерированное с помощью ИИ |
| `score` | INTEGER | Оценка релевантности новости, определенная с помощью ИИ |
| `created_at` | TIMESTAMP | Дата и время создания записи в базе данных (автоматически заполняется текущим временем) |

#### Диаграмма структуры таблицы

```
+-------------------+-------------------+------------------+
|      Поле         |       Тип         |    Описание      |
+-------------------+-------------------+------------------+
| id                | SERIAL            | Первичный ключ   |
| news_id           | TEXT (UNIQUE)     | ID новости TT-RSS|
| title             | TEXT              | Заголовок        |
| link              | TEXT              | Ссылка на новость|
| published_at      | TIMESTAMP         | Дата публикации  |
| category          | TEXT              | Категория (ИИ)   |
| summary           | TEXT              | Суммаризация (ИИ)|
| score             | INTEGER           | Оценка (ИИ)      |
| created_at        | TIMESTAMP         | Дата создания    |
+-------------------+-------------------+------------------+
```

### Безопасность и надежность

- Все конфиденциальные данные передаются через переменные окружения
- Используются параметризованные запросы к базе данных для предотвращения SQL-инъекций
- Внедрена обработка ошибок на всех этапах пайплайна
- Архитектура контейнеров обеспечивает изоляцию компонентов системы

## Тестирование

### Структура тестов

Проект включает комплексные тесты для всех основных модулей, реализованные с использованием фреймворка `testthat`:

- **Тесты для модуля хранения данных** (`tests/testthat/test-db-storage.R`) - проверяют подключение к базе данных, создание таблиц и сохранение данных
- **Тесты для клиента YandexGPT** (`tests/testthat/test-llm-client.R`) - проверяют обработку различных сценариев, включая короткие тексты и ошибки API
- **Тесты для модуля очистки текста** (`tests/testthat/test-text-cleaner.R`) - проверяют удаление HTML-тегов и нормализацию текста
- **Тесты для клиента TT-RSS** (`tests/testthat/test-ttrss-client.R`) - проверяют авторизацию, получение новостей и отметку прочитанных
- **Тесты для основного пайплайна** (`tests/testthat/test-pipeline.R`) - проверяют интеграцию всех компонентов и обработку ошибок

### Запуск тестов

Для запуска тестов используйте команду R:

```R
# Установка зависимостей
install.packages("testthat")

# Запуск всех тестов
devtools::test()
```

### Покрытие кода

Для генерации отчета о покрытии тестами используется пакет `covr`. Запустите скрипт `generate_coverage_report.R`, чтобы получить детальный отчет о покрытии в формате HTML и JSON.

