

### Используемые переменные окружения

- `TTRSS_URL`, `TTRSS_USER`, `TTRSS_PASS` - параметры для подключения к TT-RSS
- `YA_FOLDER_ID`, `YA_API_KEY` - параметры для доступа к YandexGPT
- `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASS` - параметры для подключения к PostgreSQL
- `PIPELINE_ITEMS_COUNT` - количество новостей для обработки за один запуск (по умолчанию 5)
- `PIPELINE_INTERVAL` - интервал между запусками пайплайна в секундах (по умолчанию 300)

## Архитектура

### Общая схема

Система построена по модульной архитектуре с использованием Docker-контейнеров. Основные компоненты включают:

- **TT-RSS сервер** - для получения новостей из различных RSS-лент
- **PostgreSQL база данных** - для хранения проанализированных новостей
- **Пайплайн на R** - для обработки и анализа новостей
- **Дашборд на Shiny** - для визуализации и анализа данных
- **MCP сервер** - для взаимодействия с TT-RSS через Model Context Protocol

### Важное замечание об архитектуре

**База данных с проанализированными новостями изолирована и находится на отдельном инстансе.** Это обеспечивает:
- Повышенную безопасность данных
- Независимость от основной инфраструктуры TT-RSS
- Возможность масштабирования и резервного копирования
- Разделение зон ответственности между системами

### Схема взаимодействия компонентов
![](./images/arch.png)

### Структура базы данных

#### Таблица `news_analysis`

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | SERIAL | Уникальный идентификатор записи (первичный ключ) |
| `news_id` | TEXT | Уникальный идентификатор новости из TT-RSS |
| `title` | TEXT | Заголовок новости |
| `link` | TEXT | Ссылка на новость |
| `published_at` | TIMESTAMP | Дата публикации новости |
| `category` | TEXT | Категория новости, определенная с помощью ИИ |
| `summary` | TEXT | Краткое содержание новости, сгенерированное с помощью ИИ |
| `score` | INTEGER | Оценка релевантности новости, определенная с помощью ИИ |
| `created_at` | TIMESTAMP | Дата и время создания записи в базе данных (автоматически заполняется текущим временем) |

#### Диаграмма структуры таблицы

```
+-------------------+-------------------+------------------+
|      Поле         |       Тип         |    Описание      |
+-------------------+-------------------+------------------+
| id                | SERIAL            | Первичный ключ   |
| news_id           | TEXT (UNIQUE)     | ID новости TT-RSS|
| title             | TEXT              | Заголовок        |
| link              | TEXT              | Ссылка на новость|
| published_at      | TIMESTAMP         | Дата публикации  |
| category          | TEXT              | Категория (ИИ)   |
| summary           | TEXT              | Суммаризация (ИИ)|
| score             | INTEGER           | Оценка (ИИ)      |
| created_at        | TIMESTAMP         | Дата создания    |
+-------------------+-------------------+------------------+
```

### Безопасность и надежность

- Все конфиденциальные данные передаются через переменные окружения
- Используются параметризованные запросы к базе данных для предотвращения SQL-инъекций
- Внедрена обработка ошибок на всех этапах пайплайна
- Архитектура контейнеров обеспечивает изоляцию компонентов системы

## Тестирование

### Структура тестов

Проект включает комплексные тесты для всех основных модулей, реализованные с использованием фреймворка `testthat`:

- **Тесты для модуля хранения данных** (`tests/testthat/test-db-storage.R`) - проверяют подключение к базе данных, создание таблиц и сохранение данных
- **Тесты для клиента YandexGPT** (`tests/testthat/test-llm-client.R`) - проверяют обработку различных сценариев, включая короткие тексты и ошибки API
- **Тесты для модуля очистки текста** (`tests/testthat/test-text-cleaner.R`) - проверяют удаление HTML-тегов и нормализацию текста
- **Тесты для клиента TT-RSS** (`tests/testthat/test-ttrss-client.R`) - проверяют авторизацию, получение новостей и отметку прочитанных
- **Тесты для основного пайплайна** (`tests/testthat/test-pipeline.R`) - проверяют интеграцию всех компонентов и обработку ошибок

### Запуск тестов

Для запуска тестов используйте команду R:

```R
# Установка зависимостей
install.packages("testthat")

# Запуск всех тестов
devtools::test()
```

### Покрытие кода

Для генерации отчета о покрытии тестами используется пакет `covr`. Запустите скрипт `generate_coverage_report.R`, чтобы получить детальный отчет о покрытии в формате HTML и JSON.

