library(DBI)
library(RPostgres)
library(dplyr)
# –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ç–≤–æ–π –ø–∞–∫–µ—Ç
library(NewsHarvestR)

print("üîÑ –ù–∞—á–∏–Ω–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ë–î...")

# 1. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ .env
if (file.exists(".env")) {
  readRenviron(".env")
  print("‚úÖ –§–∞–π–ª .env –Ω–∞–π–¥–µ–Ω –∏ –ø—Ä–æ—á–∏—Ç–∞–Ω.")
} else {
  stop("‚ùå –§–∞–π–ª .env –ù–ï –ù–ê–ô–î–ï–ù –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞!")
}

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
host <- Sys.getenv("DB_HOST")
if (host == "") {
  stop("‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—É—Å—Ç—ã! –ü—Ä–æ–≤–µ—Ä—å .env")
}
print(paste("üì° –ü—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫:", host))

# 3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (—Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫)
con <- tryCatch({
  connect_to_db()
}, error = function(e) {
  stop("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ", e$message)
})

print("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ —É—Å–ø–µ—à–Ω–æ!")

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
table_name <- "news_analysis"
if (!dbExistsTable(con, table_name)) {
  print(paste("‚ùå –¢–∞–±–ª–∏—Ü–∞", table_name, "–ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"))
  print("–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:")
  print(dbListTables(con))
} else {
  print(paste("‚úÖ –¢–∞–±–ª–∏—Ü–∞", table_name, "–Ω–∞–π–¥–µ–Ω–∞."))
  
  # 5. –ê–Ω–∞–ª–∏–∑ –∫–æ–ª–æ–Ω–æ–∫ (–ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø –î–ê–®–ë–û–†–î–ê)
  cols <- dbListFields(con, table_name)
  print("üìã –°–ü–ò–°–û–ö –ö–û–õ–û–ù–û–ö (–°–≤–µ—Ä—å —ç—Ç–æ —Å –∫–æ–¥–æ–º dashboard.qmd):")
  print(cols)
  
  # 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  count <- dbGetQuery(con, paste("SELECT count(*) FROM", table_name))
  print(paste("üìä –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –≤ –±–∞–∑–µ:", count))
  
  if (count > 0) {
    print("üëÄ –ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö (–ø–µ—Ä–≤—ã–µ 2 —Å—Ç—Ä–æ–∫–∏):")
    df <- dbGetQuery(con, paste("SELECT * FROM", table_name, "LIMIT 2"))
    print(df)
  } else {
    print("‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è! –î–∞—à–±–æ—Ä–¥—É –Ω–µ—á–µ–≥–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å.")
  }
}

# 7. –û—Ç–∫–ª—é—á–µ–Ω–∏–µ
dbDisconnect(con)
print("üèÅ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")